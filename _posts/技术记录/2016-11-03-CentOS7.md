---
layout: post  
title: "一个CentOS7的开发环境部署，包括防火墙|VPN|HTTP代理服务器设置等"
date: 2016-11-03
author: hunterhug
desc: "一个CentOS7的开发环境部署，包括防火墙|VPN|HTTP代理服务器设置等。"
categories: [渣渣记录]
tags: ["运维跑路"]
permalink: "/code/centos7.html"
--- 

# 一.基础安装

先从 [CentOS](https://www.centos.org/download/mirrors/) 下载镜像

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos1.png"/>
<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos2.png"/>
<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos3.png"/>

选择中文，安装模式图形界面，标注（图形界面消耗的内存大概600M，硬盘3.7G），我的硬盘是300G，请划盘如下：

```
95G /home 
200G / 
4000 swap   
250 /boot
```

以上/boot不可改，其他随便，可以不选swap，建议/划大一点，示例如下：

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos4.png"/>
<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos5.png"/>
<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos6.png"/>

设置账号，密码，然后安装完重启登陆：

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos7.png"/>
<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos8.png"/>

查看硬盘大小，内存大小：

```
free -h
df -h
```

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos9.png"/>

# 二.机器网络设置

进入图形界面，请一定在图形界面里设置，然后你就可以弃用，改用命令行了。

## 1.时间同步

先设置时间同步：

```
timedatectl 
timedatectl set-ntp true
```

## 2.设置网络

查看网卡状态：

```
ip addr 查看网卡状态
```

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos10.png"/>

填入IP和网关：

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos11.png"/>

禁掉IP6：

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos12.png"/>

查看配置，命令行手工的在这里改：

```
cat /etc/sysconfig/network-scripts/ifcfg-eno16777728
```

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos16.png"/>

这个时候还上不了网！请手动修改DNS（永生生效）

```
vim /etc/resolv.conf
```

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos13.png"/>

修改网关！

```
vim /etc/sysconfig/network
```

主机名请改掉

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos14.png"/>

## 3.禁掉虚拟网卡

有虚拟网卡的要先禁用虚拟网卡，可能有，为什么禁，不知道!

```
virsh net-list
virsh net-destroy default
virsh net-undefine default
systemctl restart libvirtd.service
```

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos15.png"/>

# 三.防火墙设置
```
#先检查是否安装了iptables
service iptables status

#安装iptables
yum install -y iptables

#升级iptables
yum update iptables 

#安装iptables-services
yum install iptables-services

#停止firewalld服务
systemctl stop firewalld

#禁用firewalld服务
systemctl mask firewalld

#查看iptables现有规则
iptables -L -n

#先允许所有,不然有可能会杯具
iptables -P INPUT ACCEPT
#清空所有默认规则
iptables -F
#清空所有自定义规则
iptables -X
#所有计数器归0
iptables -Z
#允许来自于lo接口的数据包(本地访问)
iptables -A INPUT -i lo -j ACCEPT
#开放22端口
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
#开放21端口(FTP)
iptables -A INPUT -p tcp --dport 21 -j ACCEPT
#开放80端口(HTTP)
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
#开放5902端口(VCN)
iptables -A INPUT -p tcp --dport 5902 -j ACCEPT
#开放5901端口(VNC root)
iptables -A INPUT -p tcp --dport 5901 -j ACCEPT
#开放443端口(HTTPS)
iptables -A INPUT -p tcp --dport 443 -j ACCEPT
#开放3306端口(MYSQL)
iptables -A INPUT -p tcp --dport 3306 -j ACCEPT
#允许ping
iptables -A INPUT -p icmp --icmp-type 8 -j ACCEPT
#允许接受本机请求之后的返回数据 RELATED,是为FTP设置的
iptables -A INPUT -m state --state  RELATED,ESTABLISHED -j ACCEPT
#其他入站一律丢弃
iptables -P INPUT DROP
#所有出站一律绿灯
iptables -P OUTPUT ACCEPT
#所有转发一律丢弃
iptables -P FORWARD DROP

#保存上述规则
service iptables save

#注册iptables服务
#相当于以前的chkconfig iptables on
systemctl enable iptables.service

#开启服务
systemctl start iptables.service

#查看状态
systemctl status iptables.service

#重启
systemctl restart iptables.service
```

[http://blog.chinaunix.net/uid-26495963-id-3279216.html](http://blog.chinaunix.net/uid-26495963-id-3279216.html)

[http://www.linuxso.com/linuxpeixun/10332.html](http://www.linuxso.com/linuxpeixun/10332.html)

```
vim /etc/sysconfig/iptables
```

# 四.安装VNC虚拟主机远程连接

VNC分为服务端和客户端，linux服务器主机需要安装vncserver，centos7下一般使用tigervnc。

```
yum install -y tigervnc-server
```

安装完毕后需要配置,配置vnc-server,进入目录

```
cd /lib/systemd/system
ls
```

我们会看到有个service叫做vncserver@.service，这就是我们需要的vnc服务。但是需要对它进行配置才可以使用。假设我们当前为root用户配置远程桌面，配置流程如下：
首先，复制该service，命名为vncserver@:1.service

```
cp vncserver@.service vncserver@:1.service
```

然后修改vncserver@:1.service

```
vim vncserver@:1.service
```

这里需要且只需要做一种替换：将<User>替换为需要配置的用户。注意因为root的home目录就是/root/，而不是/home/root/，所以替换后文本如下：

```
[Unit]
Description=Remote desktop service (VNC)
After=syslog.target network.target
[Service]
Type=forking
# Clean any existing files in /tmp/.X11-unix environment
ExecStartPre=/bin/sh -c '/usr/bin/vncserver -kill %i > /dev/null 2>&1 || :’
ExecStart=/sbin/runuser -l root -c “/usr/bin/vncserver %i ”
PIDFile=/root/.vnc/%H%i.pid
ExecStop=/bin/sh -c '/usr/bin/vncserver -kill %i > /dev/null 2>&1 || :’
[Install]
WantedBy=multi-user.target
```

好了，运行：

```
systemctl daemon-reload
systemctl enable vncserver@:1.service
systemctl start vncserver@:1.service
systemctl status vncserver@:1.service
```

出错！！哈哈哈，没错，上面都是浪费的流程！

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos15.png"/>

只需要：

```
systemctl daemon-reload
runuser -l root -c /usr/bin/vncserver 1 
runuser -l 其他用户 -c /usr/bin/vncserver 2 

#开放5902端口(VCN)
iptables -A INPUT -p tcp --dport 5902 -j ACCEPT
#开放5901端口(VNC root)
iptables -A INPUT -p tcp --dport 5901 -j ACCEPT

#保存上述规则
service iptables save

#重启
systemctl restart iptables.service
```

# 五.安装开发环境

## 1.Python大法

```
yum install epel-release
yum install -y pcre pcre-devel  
yum install -y zlib zlib-devel  
yum install -y openssl openssl-deve

wget https://www.python.org/ftp/python/3.4.3/Python-3.4.3.tar.xz
tar xvf Python-3.4.3.tar.xz
mkdir /usr/local/python3 
cd Python-3.4.3
./configure --prefix=/usr/local/python3
make
make install
```

安装好后请

```
vim /etc/profile.d/myenv.sh

export PATH=/usr/local/python3/bin:$PATH
export PYTHONPATH=/data/www/python/smartdo

source /etc/profile.d/myenv.sh

python3
pip3
```


## 2.MYSQL好大法

```
下载官方源
rpm -ivh mysql-community-release-el7-5.noarch.rpm
yum install mysql-server
```

```
1，进入yum源配置目录
cd /etc/yum.repos.d
2，备份系统自带的yum源
mv CentOS-Base.repo CentOS-Base.repo.bk
下载163网易的yum源：
wget http://mirrors.163.com/.help/CentOS6-Base-163.repo
3，更新玩yum源后，执行下边命令更新yum配置，使操作立即生效
yum makecache
4，除了网易之外，国内还有其他不错的yum源，比如中科大和搜狐的，大家可以根据自己需求下载
中科大的yum源：
wget http://centos.ustc.edu.cn/CentOS-Base.repo
sohu的yum源
wget http://mirrors.sohu.com/help/CentOS-Base-sohu.repo
```

```
授权
chown -R mysql:mysql /var/lib/mysqlc
service mysqld restart

#授权远程和改密码(123456是密码)
mysql -uroot
use mysql
update user set host = '%' where user ='root' and host="localhost";
select host, user from user;
update user set password=password('123456') where user='root';
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%'  IDENTIFIED BY '123456'  WITH GRANT OPTION;
flush privileges;
service mysqld restart
```

然后远程登陆后干掉其他东西，留下：

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos18.png"/>

设置权限！！

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos19.png"/>


# 六.VPN代理服务器

1.安装PPTP，以用来提供VPN服务.

```
yum install pptpd.x86_64 按tab
```

2.进行配置

```
vim /etc/pptpd.conf
```

```
localip 192.168.0.1
remoteip 192.168.0.12-238,192.168.0.245
```

localip是主机VPN内网地址，remoteip是连接VPN分配的内网地址

3.分配账号给自己使用.

```
vim /etc/ppp/chap-secrets
```

在里面添加账户按如下格式

```
hunterhug  pptpd  123456  *
hunterhug1  pptpd  123456  *
```

hunterhug为你的用户名,123456为你的密码，最后的*号表示允许在任意IP连接到服务

```
service pptpd restart
```

重启服务后发现还访问不了外网。然后我们需要让他能访问外网。首先，

```
vim /etc/ppp/pptpd-options

文件名可能为
vim /etc/ppp/options.pptpd
```

找到ms-dns，取消掉注释，改成你喜欢的DNS比如8.8.8.8,8.8.4.4

要开启内核IP转发

```
sudo vi /etc/sysctl.conf
取消掉 net.ipv4.ip_forward=1 这一行的注释. 可能找不到这一句
```

然后执行

```
sudo sysctl -p
```

使修改后的文件配置立即生效。

开启NAT转发.

```
iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -o eno16777728 -j MASQUERADE
service iptables save
service iptables restart
```

192.168.0.0/24是你在上面设置的IP段，让这个段转发,注意eno16777728是你连接外网的那块网卡，这样就以NAT的方式请求外网的东西了。
不知道你的机器哪块网卡连的外网的话ifconfig一下!!

再来一次
```
service pptpd restart
```

```
NAT（Network Address Translation，网络地址转换）是1994年提出的。当在专用网内部的一些主机本来已经分配到了本地IP地址（即仅在本专用网内使用的专用地址），但现在又想和因特网上的主机通信（并不需要加密）时，可使用NAT方法。
这种方法需要在专用网连接到因特网的路由器上安装NAT软件。装有NAT软件的路由器叫做NAT路由器，它至少有一个有效的外部全球IP地址。这样，所有使用本地地址的主机在和外界通信时，都要在NAT路由器上将其本地地址转换成全球IP地址，才能和因特网连接。
另外，这种通过使用少量的公有IP 地址代表较多的私有IP 地址的方式，将有助于减缓可用的IP地址空间的枯竭。在RFC 1632中有对NAT的说明
```

如果不行的话防火墙上,全部接受，完美！！

```
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
iptables -P INPUT ACCEPT
service iptables save
service iptables restart
```

查看/etc/sysconfig/iptables,结果是这样的，这样肯定不行，求告知！！

```
[root@spider2 ~]# cat /etc/sysconfig/iptables
# Generated by iptables-save v1.4.21 on Fri Nov  4 10:01:51 2016
*filter
:INPUT ACCEPT [4:192]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [49:7158]
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 21 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p tcp -m tcp --dport 3306 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 5902 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 5901 -j ACCEPT
COMMIT
# Completed on Fri Nov  4 10:01:51 2016
# Generated by iptables-save v1.4.21 on Fri Nov  4 10:01:51 2016
*nat
:PREROUTING ACCEPT [50:2445]
:INPUT ACCEPT [16:835]
:OUTPUT ACCEPT [24:1821]
:POSTROUTING ACCEPT [24:1821]
-A POSTROUTING -s 192.168.0.0/24 -o eno16777728 -j MASQUERADE
COMMIT
# Completed on Fri Nov  4 10:01:51 2016
```
参考：[http://www.cnblogs.com/apexchu/p/4274416.html](http://www.cnblogs.com/apexchu/p/4274416.html)

# 7.HTTP代理服务器（多网关，多IP）(待写）

```
方法1：少量IP手动绑定（这里以绑定IP到eth0为例，其它网卡的话修改相应的文件名即可）
1.复制ifcfg-eth0的网卡配置文件并改名为ifcfg-eth0:0
[root@akinlau /]# cp /etc/sysconfig/network-scripts/ifcfg-eth0 /etc/sysconfig/network-scripts/ifcfg-eth0:0
2.编辑ifcfg-eth0:0文件
[root@akinlau /]# vim /etc/sysconfig/network-scripts/ifcfg-eth0:0
DEVICE=”eth0:0″ //这里修改为eth0:0跟文件名保持一致
BOOTPROTO=”static” //协议为静态，用none也可以
HWADDR=”00:0C:29:6F:62:A7″ //MAC地址
ONBOOT=”yes” //开机启用此网卡
IPADDR=192.168.1.3 //新绑定的IP
NETMASK=255.255.255.0 //子网掩码
GATEWAY=192.168.1.1 //网关
修改好后保存退出，然后启用这张网卡
[root@akinlau /]# ifup eth0:0
注：有人在这一步喜欢用service network restart重启网络，其实这是没必要的，只需要启用这张网卡就可以了
然后再试ping 一下，如果能ping通的话，就可以了。
方法2：自动绑定一个IP段或多个IP段（同样这里以eth0为例，其它网卡的话修改相应的文件名即可）
1.新建ifcfg-eth0-range0文件（注意这里的文件名不要调换range的位置或写错单词，不然的话绑定的IP是不会生效的，如果你还有几段IP要绑定到eth0上的话，你可以再新建ifcfg-eth0-range1, ifcfg-eth0-range2等文件，不过这里要注意每个range文件中的定义的CLONENUM_START值不能重叠，不然的话会出问题。 ）
[root@akinlau /]# /etc/sysconfig/network-scripts/ifcfg-eth0-range0
#写入以下内容
DEVICE=eth0 //绑定IP段的网卡名称
ONBOOT=yes //开机启用此网卡
BOOTPROTO=static //协议为静态
IPADDR_START=192.168.0.101 //网段的起始IP
IPADDR_END=192.168.0.120 //网段的截止IP
NETMASK=255.255.255.255 //子网掩码
CLONENUM_START=0 //这个数字是网卡别名的开始位置，比如这里的3是指eth0:0,并且会把IPADDR_START设置的IP192.168.0.101绑定到eth0:0上,以此类推
NO_ALIASROUTING=yes //这个参数的作用是数据包始终通过eth0进出，不走网卡别名（如eth0:0），设置这个参数可以加快路由的响应速度，所以强烈建议配置。
修改好后保存退出，然后重启网络：
[root@akinlau /]# service network restart
再测试一下，能不能ping就大功告成了。
http://doc.okbase.net/panblack/archive/103816.html
```

使用squid

```
#安装
yum -y install squid

# 版本
squid -v

#开机使用
chkconfig --level 35 squid on

#安装密码
yum install httpd-tools
htpasswd  -c /etc/squid/passwd username

# 一定要设置！！
chmod 777 /etc/squid/passwd 


#编辑
vim /etc/squid/squid.conf 

# 最后面加入
auth_param basic program /usr/lib64/squid/basic_ncsa_auth /etc/squid/passwd
auth_param basic children 200
auth_param basic credentialsttl 12 hours
auth_param basic realm proxy
acl authenticated proxy_auth REQUIRED
http_access allow authenticated

# Squid normally listens to port 3128
http_port 808

# And finally deny all other access to this proxy
http_access deny all


```

扩大linux的文件描述符
```
一，通过ulimit命令修改
 
//显示当前文件描述符
ulimit -n
 
//修改当前用户环境下的文件描述符为65536
ulimit -HSn 65536
 
echo "ulimit -HSn 65536" >> /etcrc.local
 
使用ulimit命令的缺点：
 
1，只能修改当前登录用户环境下的文件描述符，如果此用户来另外打开一个连接，此链接环境的文件描述符依然是没改前的
2，如果系统重启，以前修改都不再生效
 
二，通过修改limits.conf文件
 
编辑/etc/security/limits.conf 文件，在最后加入如下两行
 
*  soft    nofile  65536
*  hard    nofile  65536
 
保存退出，都不需要重启服务器，直接重新登陆用ulimit -n就能看到效果
 
这样无论使用哪个用户，无论是否重启都不会失效了。
 
扩大linux的文件描述符后，再重新编译安装squid，安装完成后，重新启用此代理，发现连接数马上就上来了
```

```
查看状态
squid -Nd1

ls /var/log/squid/
# 启动
systemctl start squid.service
# 停止
systemctl stop squid.service
# 重启
systemctl restart squid.service

#开端口
iptables -A INPUT -p tcp --dport 808 -j ACCEPT

```

出错！！

```
squid -z  #初始化缓存
#按提示操作
journalctl -xe
```


如果只是用squid做代理，不想缓存所有网站文件的话，可以修改squid配置,read-only选项指示Squid继续从cache_dir读取文件，但不往里面写新目标。它在squid.conf文件里看起来如下：
```
将squid.conf里的cache_dir ufs /home/cache 1024 16 256    改成cache_dir ufs /home/cache 1024 16 256 read-only

保存  然后,检查一下,有没有语法错误:

#squid -k parse
#squid -k reconfigure
```
[http://blog.csdn.net/mingzznet/article/details/52921218](http://blog.csdn.net/mingzznet/article/details/52921218)
[http://os.51cto.com/art/201104/256479.htm](http://os.51cto.com/art/201104/256479.htm)

或者使用
```
yum install tinyproxy
vim  /etc/tinyproxy.conf
```

[http://www.cnblogs.com/mchina/p/3812190.html](http://www.cnblogs.com/mchina/p/3812190.html)