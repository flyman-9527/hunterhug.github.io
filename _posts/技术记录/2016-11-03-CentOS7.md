---
layout: post  
title: "一个CentOS7的开发环境部署，包括防火墙|VPN|HTTP代理服务器设置等"
date: 2016-11-03
author: hunterhug
desc: "一个CentOS7的开发环境部署，包括防火墙|VPN|HTTP代理服务器设置等。"
categories: [渣渣记录]
tags: ["运维跑路"]
permalink: "/code/centos7.html"
--- 

# 1.基础安装

先从 [CentOS](https://www.centos.org/download/mirrors/) 下载镜像

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos1.png"/>
<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos2.png"/>
<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos3.png"/>

选择中文，安装模式图形界面，标注（图形界面消耗的内存大概600M，硬盘3.7G），我的硬盘是300G，请划盘如下：

```
95G /home 
200G / 
4000 swap   
250 /boot
```

以上/boot不可改，其他随便，可以不选swap，建议/划大一点，示例如下：

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos4.png"/>
<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos5.png"/>
<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos6.png"/>

设置账号，密码，然后安装完重启登陆：

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos7.png"/>
<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos8.png"/>

查看硬盘大小，内存大小：

```
free -h
df -h
```

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos9.png"/>

# 2.网络设置

进入图形界面，请一定在图形界面里设置，然后你就可以弃用，改用命令行了。

先设置时间同步：

```
timedatectl 
timedatectl set-ntp true
```

查看网卡状态：

```
ip addr 查看网卡状态
```

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos10.png"/>

填入IP和网关：

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos11.png"/>

禁掉IP6：

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos12.png"/>

查看配置，命令行手工的在这里改：

```
cat /etc/sysconfig/network-scripts/ifcfg-eno16777728
```

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos16.png"/>

这个时候还上不了网！请手动修改DNS

```
vim /etc/resolv.conf
```

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos13.png"/>

修改网关！

```
vim /etc/sysconfig/network
```

主机名请改掉

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos14.png"/>

有虚拟网卡的要先禁用虚拟网卡，可能有，为什么禁，不知道!

```
virsh net-list
virsh net-destroy default
virsh net-undefine default
systemctl restart libvirtd.service
```

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos15.png"/>

# 3.防火墙
```
#先检查是否安装了iptables
service iptables status

#安装iptables
yum install -y iptables

#升级iptables
yum update iptables 

#安装iptables-services
yum install iptables-services

#停止firewalld服务
systemctl stop firewalld

#禁用firewalld服务
systemctl mask firewalld

#查看iptables现有规则
iptables -L -n

#先允许所有,不然有可能会杯具
iptables -P INPUT ACCEPT
#清空所有默认规则
iptables -F
#清空所有自定义规则
iptables -X
#所有计数器归0
iptables -Z
#允许来自于lo接口的数据包(本地访问)
iptables -A INPUT -i lo -j ACCEPT
#开放22端口
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
#开放21端口(FTP)
iptables -A INPUT -p tcp --dport 21 -j ACCEPT
#开放80端口(HTTP)
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
#开放5902端口(VCN)
iptables -A INPUT -p tcp --dport 5902 -j ACCEPT
#开放5901端口(VNC root)
iptables -A INPUT -p tcp --dport 5901 -j ACCEPT
#开放443端口(HTTPS)
iptables -A INPUT -p tcp --dport 443 -j ACCEPT
#开放3306端口(MYSQL)
iptables -A INPUT -p tcp --dport 3306 -j ACCEPT
#允许ping
iptables -A INPUT -p icmp --icmp-type 8 -j ACCEPT
#允许接受本机请求之后的返回数据 RELATED,是为FTP设置的
iptables -A INPUT -m state --state  RELATED,ESTABLISHED -j ACCEPT
#其他入站一律丢弃
iptables -P INPUT DROP
#所有出站一律绿灯
iptables -P OUTPUT ACCEPT
#所有转发一律丢弃
iptables -P FORWARD DROP

#保存上述规则
service iptables save

#注册iptables服务
#相当于以前的chkconfig iptables on
systemctl enable iptables.service

#开启服务
systemctl start iptables.service

#查看状态
systemctl status iptables.service

#重启
systemctl restart iptables.service
```


# 4.安装VNC虚拟主机远程连接

VNC分为服务端和客户端，linux服务器主机需要安装vncserver，centos7下一般使用tigervnc。

```
yum install -y tigervnc-server
```

安装完毕后需要配置,配置vnc-server,进入目录

```
cd /lib/systemd/system
ls
```

我们会看到有个service叫做vncserver@.service，这就是我们需要的vnc服务。但是需要对它进行配置才可以使用。假设我们当前为root用户配置远程桌面，配置流程如下：
首先，复制该service，命名为vncserver@:1.service

```
cp vncserver@.service vncserver@:1.service
```

然后修改vncserver@:1.service

```
vim vncserver@:1.service
```

这里需要且只需要做一种替换：将<User>替换为需要配置的用户。注意因为root的home目录就是/root/，而不是/home/root/，所以替换后文本如下：

```
[Unit]
Description=Remote desktop service (VNC)
After=syslog.target network.target
[Service]
Type=forking
# Clean any existing files in /tmp/.X11-unix environment
ExecStartPre=/bin/sh -c '/usr/bin/vncserver -kill %i > /dev/null 2>&1 || :’
ExecStart=/sbin/runuser -l root -c “/usr/bin/vncserver %i ”
PIDFile=/root/.vnc/%H%i.pid
ExecStop=/bin/sh -c '/usr/bin/vncserver -kill %i > /dev/null 2>&1 || :’
[Install]
WantedBy=multi-user.target
```

好了，运行：

```
systemctl daemon-reload
systemctl enable vncserver@:1.service
systemctl start vncserver@:1.service
systemctl status vncserver@:1.service
```

出错！！哈哈哈，没错，上面都是浪费的流程！

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos15.png"/>

只需要：

```
systemctl daemon-reload
runuser -l root -c /usr/bin/vncserver 1  开5901端口
runuser -l 其他用户 -c /usr/bin/vncserver 2  开5902端口

```

# 5. 安装开发环境

export PATH=/usr/local/python3/bin:$PATH
export PYTHONPATH=/data/www/python/smartdo

```
下载官方源
rpm -ivh mysql-community-release-el7-5.noarch.rpm
yum install mysql-server

授权
chown -R mysql:mysql /var/lib/mysqlc
service mysqld restart

#授权远程和改密码(123456是密码)
mysql -uroot
use mysql
update user set host = '%' where user ='root' and host="localhost";
select host, user from user;
update user set password=password('123456') where user='root';
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%'  IDENTIFIED BY '123456'  WITH GRANT OPTION;
flush privileges;
service mysqld restart
```

然后远程登陆后干掉其他东西，留下：

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos18.png"/>

设置权限！！

<img  src="https://raw.githubusercontent.com/hunterhug/hunterhug.github.io/master/img/centos/centos19.png"/>